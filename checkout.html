<!DOCTYPE html>
<html lang="en">
<header>
<a href="shop.html"><img src="logo.png" alt="Nine Ball Logo"></a>
</header>


<main>
<h1>Checkout</h1>


<div class="checkout-container">


<div class="checkout-summary">
<h2>Order Summary</h2>
<div id="cartItems"></div>
<p class="total" id="totalPrice">Total: £0.00</p>
</div>


<div class="checkout-form">
<h2>Shipping & Payment</h2>


<form id="checkout-form">
<label>Full Name</label>
<input type="text" id="name" required>


<label>Email</label>
<input type="email" id="email" required>


<label>Address</label>
<textarea id="address" rows="3" required></textarea>


<p>You’ll be redirected to Stripe’s secure payment page.</p>


<button id="stripeBtn" type="button" disabled>Pay with Stripe</button>
</form>


<a href="shop.html" class="back-to-shop">← Back to Shop</a>
</div>


</div>
</main>


<footer>
<p>© 2025 The Nine Ball</p>
</footer>


<script src="checkout.js"></script>

<script>
/* CART LOGIC */
const cart = JSON.parse(localStorage.getItem("cart")) || [];
const cartItems = document.getElementById("cartItems");
const totalPriceElem = document.getElementById("totalPrice");
const stripeBtn = document.getElementById("stripeBtn");
const nameInput = document.getElementById("name");
const emailInput = document.getElementById("email");
const addressInput = document.getElementById("address");

function renderCart() {
  cartItems.innerHTML = "";
  let total = 0;

  cart.forEach((item, i) => {
    total += parseFloat(item.price);

    const div = document.createElement("div");
    div.classList.add("cart-item");

    div.innerHTML = `
      <div class="cart-item-details">
        <p>${item.name} (${item.size})</p>
        <p class="cart-item-small">£${item.price}</p>
      </div>
      <button data-index="${i}">Remove</button>
    `;

    div.querySelector("button").addEventListener("click", () => {
      cart.splice(i, 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
      checkFormFields();
    });

    cartItems.appendChild(div);
  });

  totalPriceElem.textContent = `Total: £${total.toFixed(2)}`;
}

function checkFormFields() {
  stripeBtn.disabled = !(nameInput.value && emailInput.value && addressInput.value && cart.length > 0);
}

[nameInput, emailInput, addressInput].forEach(input =>
  input.addEventListener("input", checkFormFields)
);

renderCart();
checkFormFields();

stripeBtn.addEventListener('click', async () => {
  try {
    stripeBtn.disabled = true;
    stripeBtn.textContent = "Redirecting...";

    const total = cart.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);

    const response = await fetch("https://api.thenineball.co.uk/api/create-checkout", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        total,
        customerEmail: emailInput.value.trim(),
        metadata: {
          name: nameInput.value.trim(),
          address: addressInput.value.trim(),
          cart: JSON.stringify(cart)
        }
      })
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error || "Checkout failed");

    window.location.href = data.url;

  } catch (err) {
    alert("Error: " + err.message);
    stripeBtn.disabled = false;
    stripeBtn.textContent = "Pay with Stripe";
  }
});

</script>
</body>
</html>
