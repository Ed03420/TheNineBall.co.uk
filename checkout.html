<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Checkout - The Nine Ball</title>
<style>
  /* (kept your original CSS exactly) */
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Poppins', sans-serif; background:#0e0e0e; color:#fff; line-height:1.6; padding-top:100px; display:flex; flex-direction:column; min-height:100vh; }
  a { color:#c7a86c; text-decoration:none; }
  a:hover { text-decoration:underline; }
  header { position:fixed; top:0; width:100%; z-index:1000; display:flex; justify-content:space-between; align-items:center; padding:1rem 2rem; background:rgba(0,0,0,0.95); border-bottom:1px solid #111; }
  header img { height:60px; border-radius:12px; }
  main { max-width:980px; margin:0 auto; padding:2.25rem 1.25rem; flex:1; }
  h1 { font-size:2rem; color:#c7a86c; margin-bottom:1.5rem; letter-spacing:0.5px; text-align:center; }
  .checkout-container { display:flex; flex-wrap:wrap; gap:2rem; align-items:flex-start; }
  .checkout-summary, .checkout-form { flex:1 1 420px; background:#151515; border:1px solid #2b2b2b; border-radius:12px; padding:1.5rem; box-shadow:0 8px 30px rgba(0,0,0,0.6); }
  .checkout-summary h2, .checkout-form h2 { color:#c7a86c; font-size:1.3rem; margin-bottom:1rem; border-bottom:1px solid #2b2b2b; padding-bottom:0.6rem; }
  .cart-item { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; border-bottom:1px solid #232323; padding-bottom:0.6rem; }
  .cart-item img { width:60px; height:60px; object-fit:cover; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.5); }
  .cart-item-details { flex:1; margin-left:0.75rem; }
  .cart-item-details p { margin:0; font-size:0.95rem; line-height:1.3; }
  .cart-item-small { color:#bdbdbd; font-size:0.85rem; margin-top:0.25rem; }
  .total { font-weight:700; color:#c7a86c; text-align:right; font-size:1.1rem; margin-top:1rem; }
  label { display:block; margin-bottom:0.3rem; margin-top:0.8rem; font-weight:600; color:#e5e5e5; }
  input, textarea { width:100%; padding:0.6rem 0.8rem; border-radius:8px; border:1px solid #2a2a2a; background:#0f0f0f; color:#fff; margin-bottom:0.6rem; }
  textarea { resize:none; }
  .place-order { background:#c7a86c; color:#000; border:none; padding:0.8rem 1.25rem; border-radius:10px; font-weight:700; cursor:pointer; width:100%; margin-top:1rem; transition:all 0.2s ease; }
  .place-order:disabled { opacity:0.5; cursor:not-allowed; }
  .place-order:hover:enabled { background:#fff; }
  .back-to-shop { display:block; margin-top:1.2rem; text-align:center; color:#c7a86c; border:1px solid #2b2b2b; border-radius:10px; padding:0.6rem 1rem; font-weight:700; text-decoration:none; }
  .back-to-shop:hover { background:#c7a86c; color:#000; border-color:transparent; }
  footer { text-align:center; padding:2rem 1rem; background:#000; border-top:1px solid rgba(255,255,255,0.04); color:#bbb; margin-top:2rem; }
  @media (max-width:880px) { main { padding:1.5rem; } .checkout-container { flex-direction:column; gap:1.25rem; } }
</style>
</head>
<body>

<header>
  <a href="shop.html"><img src="WhatsApp Image 2025-10-18 at 8.49.10 AM (1).jpeg" alt="The Nine Ball Logo"></a>
</header>

<main>
  <h1>Checkout</h1>
  <div class="checkout-container">

    <!-- Cart Summary -->
    <div class="checkout-summary">
      <h2>Order Summary</h2>
      <div id="cartItems"></div>
      <p class="total" id="totalPrice"></p>
    </div>

    <!-- Checkout Form -->
    <div class="checkout-form">
      <h2>Shipping & Payment</h2>
      <form id="checkout-form">
        <label for="name">Full Name</label>
        <input type="text" id="name" required>

        <label for="email">Email</label>
        <input type="email" id="email" required>

        <label for="address">Shipping Address</label>
        <textarea id="address" rows="3" required></textarea>

        <p>You’ll be redirected to Stripe’s secure checkout page to complete your order.</p>
        <button type="button" id="stripeBtn" class="place-order" disabled>Pay with Card</button>
      </form>
      <a href="shop.html" class="back-to-shop">← Back to Shop</a>
    </div>

  </div>
</main>

<footer>
  <p>&copy; 2025 The Nine Ball. All Rights Reserved.</p>
  <p><a href="index.html">Back to Home</a></p>
</footer>

<script>
/* Checkout frontend logic:
   - fetch publishable key from /api/config
   - init Stripe client
   - create checkout session via /api/create-checkout
*/

const cart = JSON.parse(localStorage.getItem('cart')) || [];
const cartItemsContainer = document.getElementById('cartItems');
const totalPriceElem = document.getElementById('totalPrice');
const stripeBtn = document.getElementById("stripeBtn");
const nameInput = document.getElementById("name");
const emailInput = document.getElementById("email");
const addressInput = document.getElementById("address");

function escapeHtml(text = "") {
  return text.replace(/[&<>"']/g, function(m) {
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[m];
  });
}

function renderCart() {
  cartItemsContainer.innerHTML = '';
  let total = 0;

  if (cart.length === 0) {
    cartItemsContainer.innerHTML = `<p style="color:#777">Your cart is empty.</p>`;
  }

  cart.forEach((item, index) => {
    const price = parseFloat(item.price) || 0;
    total += price;

    const div = document.createElement('div');
    div.className = 'cart-item';

    div.innerHTML = `
      <div class="cart-item-details">
        <p>${escapeHtml(item.name)} ${item.size ? `(${escapeHtml(item.size)})` : ''}</p>
        <p class="cart-item-small">£${price.toFixed(2)}</p>
      </div>
      <button data-index="${index}" type="button">Remove</button>
    `;

    div.querySelector('button').addEventListener('click', () => {
      cart.splice(index, 1);
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
      checkFormFields();
    });

    cartItemsContainer.appendChild(div);
  });

  totalPriceElem.textContent = `Total: £${total.toFixed(2)}`;
}

function checkFormFields() {
  stripeBtn.disabled = !(
    nameInput.value.trim() &&
    emailInput.value.trim() &&
    addressInput.value.trim() &&
    cart.length > 0
  );
}

[nameInput, emailInput, addressInput].forEach(input =>
  input.addEventListener('input', checkFormFields)
);

renderCart();
checkFormFields();

let stripe; // will hold Stripe instance

// Fetch publishable key then wire the button
async function initStripe() {
  try {
    const res = await fetch("/api/config");
    const json = await res.json();
    if (!res.ok) throw new Error(json.error || "Failed to get config");
    const publishableKey = json.publishableKey;
    if (!publishableKey) throw new Error("No publishable key returned");

    // Load Stripe JS dynamically
    const s = await loadStripeJs();
    stripe = s(publishableKey);
  } catch (err) {
    console.error("Stripe init error:", err);
    // Keep button disabled
  }
}

// helper to load stripe js and return window.Stripe initializer
function loadStripeJs() {
  return new Promise((resolve, reject) => {
    if (window.Stripe) return resolve(window.Stripe);
    const script = document.createElement("script");
    script.src = "https://js.stripe.com/v3/";
    script.async = true;
    script.onload = () => {
      if (window.Stripe) return resolve(window.Stripe);
      reject(new Error("Stripe JS failed to load"));
    };
    script.onerror = () => reject(new Error("Stripe JS failed to load"));
    document.head.appendChild(script);
  });
}

stripeBtn.addEventListener('click', async () => {
  if (!stripe) {
    alert("Payment system not initialized. Try refreshing the page.");
    return;
  }

  try {
    stripeBtn.disabled = true;
    stripeBtn.textContent = "Redirecting...";

    const total = cart.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);

    const response = await fetch("/api/create-checkout", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        total,
        customerEmail: emailInput.value.trim(),
        metadata: {
          name: nameInput.value.trim(),
          address: addressInput.value.trim(),
          cart: JSON.stringify(cart)
        }
      })
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error || "Checkout failed");

    // redirect directly to Stripe Checkout url returned by server
    window.location.href = data.url;

  } catch (err) {
    alert("Error: " + (err.message || err));
    stripeBtn.disabled = false;
    stripeBtn.textContent = "Pay with Card";
  }
});

// initialize on load
initStripe();
</script>
</body>
</html>
